{
  "kind": "build_request",
  "title": "Fix holder data system with historical backfill and ongoing indexing",
  "projectName": "BITTY ON ICP INDEX",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-67",
      "text": "Implement robust historical backfill in backend that fetches ALL transactions from ledger canister qroj6-lyaaa-aaaam-qeqta-cai since the token's inception using ICRC-2 standard, processing transactions in batches to handle the complete transaction history efficiently",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Implement robust historical backfill that fetches ALL transactions from ledger canister qroj6-lyaaa-aaaam-qeqta-cai since the token's inception"
        ]
      },
      "acceptanceCriteria": [
        "Backend fetches all historical transactions from ledger canister qroj6-lyaaa-aaaam-qeqta-cai using ICRC-2 icrc3_get_blocks method",
        "Historical backfill executes automatically on canister deployment/upgrade",
        "Transaction processing handles batches efficiently to avoid timeout issues",
        "All transactions from token launch to present are stored in stable memory"
      ]
    },
    {
      "id": "REQ-68",
      "text": "Build comprehensive holder tracking system in backend that analyzes all fetched transactions to identify the complete list of 344 current holders by tracking all transfer events (to/from addresses) and filtering out addresses with zero balances",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Build a comprehensive holder tracking system that analyzes these transactions to identify all 344 current holders"
        ]
      },
      "acceptanceCriteria": [
        "System analyzes all transactions to extract unique holder addresses",
        "Holder compilation tracks both sender and recipient addresses from transfer events",
        "System identifies all 344 holders matching ICPSwap pool data",
        "Addresses with zero balance are excluded from the holder list"
      ]
    },
    {
      "id": "REQ-69",
      "text": "Query live balances for each identified holder address using ICRC-2 icrc1_balance_of method from ledger canister qroj6-lyaaa-aaaam-qeqta-cai to get accurate current balance data, implementing batch queries to handle 344+ addresses efficiently",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Query live balances for each holder using ICRC-2 icrc1_balance_of to get accurate current data"
        ]
      },
      "acceptanceCriteria": [
        "Backend queries icrc1_balance_of for each holder address from ledger canister qroj6-lyaaa-aaaam-qeqta-cai",
        "Balance queries handle 344+ addresses efficiently using batch processing",
        "Live balance data is accurate and reflects current token holdings",
        "Zero balance addresses are filtered out of the final holder list"
      ]
    },
    {
      "id": "REQ-70",
      "text": "Calculate and store percentage of total supply (999,999,999.92M BITTYICP) held by each address in the holder data structure, storing holder records with address, balance, and supply percentage in stable memory",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "all 344 holders who still hold tokens from launch, with their balances and percentage of total supply"
        ]
      },
      "acceptanceCriteria": [
        "Each holder record includes address, balance in BITTYICP tokens, and percentage of total supply",
        "Supply percentage calculation uses 999,999,999.92M as total supply",
        "Holder data is stored in stable memory for persistence across upgrades",
        "Holder list is sorted by balance in descending order"
      ]
    },
    {
      "id": "REQ-71",
      "text": "Fix the existing 5-minute polling timer in backend to maintain holder data going forward with incremental updates, processing only new transactions since the last poll to update holder balances efficiently without re-scanning the entire ledger",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Set up the 5-minute polling timer to maintain this data going forward with incremental updates"
        ]
      },
      "acceptanceCriteria": [
        "Polling timer executes every 5 minutes (300 seconds) using Internet Computer timer API",
        "Timer fetches only new transactions since last poll using transaction index tracking",
        "Holder balances are updated incrementally based on new transfer events",
        "Timer continues running after historical backfill completes"
      ]
    },
    {
      "id": "REQ-72",
      "text": "Add comprehensive error handling and logging throughout the backend indexing system including historical backfill, balance queries, timer execution, and holder compilation to capture failures and provide visibility into the indexing process status",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "Add proper error handling and logging so you can see what's happening in the indexing process"
        ]
      },
      "acceptanceCriteria": [
        "All ledger canister queries include error handling with meaningful error messages",
        "Historical backfill logs progress (transactions fetched, holders identified)",
        "Timer execution logs each poll attempt with success/failure status",
        "Balance query failures are logged with address and error details",
        "Backend exposes indexing status query for frontend to display progress"
      ]
    },
    {
      "id": "REQ-73",
      "text": "Update frontend HolderList component and useHolderData hook to properly fetch and display the complete holder list from the fixed backend, showing all 344 holders with their addresses, BITTYICP balances, and percentage of total supply in the table",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-last"
        ],
        "quotes": [
          "I have a total of 344 authentic addresses right now according to ICPSwap pool. Right now my page shows 0 addresses and balances"
        ]
      },
      "acceptanceCriteria": [
        "HolderList component displays all 344 holders fetched from backend",
        "Table shows address, balance in BITTYICP, and percentage of total supply for each holder",
        "useHolderData hook successfully queries backend getHolderData method",
        "Loading states display while fetching holder data",
        "Error states are cleared once data loads successfully"
      ]
    }
  ],
  "constraints": [
    "Maintain single-actor architecture with all Motoko logic in backend/main.mo",
    "Use ledger canister qroj6-lyaaa-aaaam-qeqta-cai with ICRC-2 standard for all balance and transaction queries",
    "Preserve existing stable memory structures for transaction rolling window (last 100 transactions)",
    "Do not modify immutable frontend paths: useInternetIdentity.ts, useInternetIdentity.tsx, useActor.ts, main.tsx, components/ui",
    "Total supply must remain 999,999,999.92M BITTYICP for all calculations"
  ],
  "nonGoals": [
    "Fixing address search functionality (separate issue for later)",
    "Fixing transaction list display (separate issue for later)",
    "Modifying token metrics section or price display",
    "Changing UI styling or visual design of holder table",
    "Adding new features beyond holder data fix"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}